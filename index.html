<title>E$timator</title>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" />
<link href="data:image/x-icon;base64,AAABAAEAEBAAAAAAAABoBQAAFgAAACgAAAAQAAAAIAAAAAEACAAAAAAAAAEAAAAAAAAAAAAAAAEAAAAAAAAAAAAAgNCvABOwZQB11HQAGK9iABmvYgA0w2cA+f3zAGTTpwBs0ZgAS51zAJffiwDW86oAxfB1AAJ4RgBp0WMAe9aVANTywgBVzJwAbtJdAHXYpAB22KQA8/zWAHzMrQBiyo0ASMJ2AKTjlwAJrmkAYsqWAIDPrQAEt3IAQseOAEaaawA/zZcAA247AAZuOwDP8bcACHE7AAlxOwAPwXUAG7dpAGTcsQBTo30ABKpnAGHKhQBZy5oA8PvdAGPOiADy++YAf8+uAIDPrgBhoIYA+v7vANn1lwBZy3cAvOuMAJzghwD+//sACXE8AFPIkgDL8msAB3lCABfDcwDF7p4Ae9CyAITYlAB/z68A5vm+AANtOgBo0aQAYtaqAGLOXQABdUAAGbZoAL3shwAVw3QActekAHPXpAB81ZUA4/mbAGDNkACC2JUACqxmAFbUpQBr0H4AedW5AGLNmQAxvmUAFK5jADDCaAAcsWMAHbFjAAhwOwCB2WwAQcNiALfooABJ0Z0AA3hBAHnVjQA6lF0Awu6FAEnGYgCr5ncAAVktACm7ZgBv02QADqtkAJDdgQCh42YAb9KXAFnGfQBp1KYAQMNjAEHDYwD///4AsepOABbDdgA+xn4AJL9qAHzOrwDi+KwAfc6vAH7OrwAtjlYAMMJqADTAZADi980AN8BkABmwYgA4wGQAUceBAE/HigD9/vwA////AC/JiAAitGUAcNakAPH80wCJ2noAxe2WAHHTXQCA15UAD35DAPf96AD4/egAkNyJAOf5uQD5/usAE7VpAGDNXgAGbzsAFblsAP3/9wABd0EAAndBAEDDZQBt1qUAddSWAO770QDj+ZYAhNmBACa6ZgCm5IYABqtnAPD74wCN3HgAEa1kAAyyagCo5KEAAms5AAm/dgBKypUAPsJjAAOjYgBt1qYAu+ukAG3SXAC966QAdtijAAeqZQAmumcAQZhkAD7FhwA2y5AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABnqUSWXCUmJjo6XCMiDgAASK2zalgEgFpbWwWmGx4AAJkrp0m0V4GsXnB/oZeqAACao5S0a6+VsKKxXXF2JwAAYVIofUekbGSFOQdpWUsAAD0CaGUTSkN4kDyFawY+AACOh5uMZnMWn3KFjw98dAAAexkDLoWYT4kNP6U2dYYAAGNuGoU1NJKei4pUgra3AAC1LAuEk3IMNzCgL4MfIQAAIBhiX34kOJERqFA7q2AAAAocbU5RQY0QnQlWLRJTAAAqRa5NFbIUTIicbwhGKQAAMxd6Mh0dMQExQnl3QFUAAAAAAAAAAAAAAAAAAAAAAP//AACAAQAAgAEAAIABAACAAQAAgAEAAIABAACAAQAAgAEAAIABAACAAQAAgAEAAIABAACAAQAAgAEAAP//AAA=" rel="icon" type="image/x-icon" />

<style>

html,
body {
    height: 100%;
    margin: 0;
    padding: 0;
}

body {
    align-items: stretch;
    background-color: #cdcdcd;
    display: flex;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    width: 100%;
    height: 100%;

    /* Purpose: disable text selection */
    cursor: default;
    user-select: none;
}

main {
    flex-grow: 1;
    overflow-y: scroll;
    scroll-behavior: smooth;
}

table {
    background-color: #ddd;
    border-collapse: separate;
    border-spacing: 0;
    width: 100%;
}

tr:nth-child(odd) {
    background-color: #000;
}

td {
    font-size: 2rem;
    padding: 4px 4px 2px 4px;
    text-align: right;
    white-space: nowrap;
    background-color: #eee;
}

td:nth-child(1) {
    width: 1%;
}
td:nth-child(2) {
    width: 33%;
}
td:nth-child(3) {
    width: 33%;
}
td:nth-child(4) {
    width: 33%;
}

.neg td {
    background-color: rgba(255, 208, 203, .9);
}

.pos td {
    background-color: rgba(225, 255, 203, .9);
}

footer {
    align-items: normal;
    background-color: #eee;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    flex-grow: 1;
    justify-content: center;
    max-width: 33%;
    overflow: hidden;
    padding: 18px;
    position: relative;
    width: 33%;
}

label {
    display: block;
    font-size: 0.8rem;
    white-space: nowrap;
    text-transform: uppercase;
}

input {
    background-color: #fff;
    border-radius: 4px;
    border-width: 1px;
    color: #000;
    font-size: 2rem;
    margin-bottom: .52em;
    width: 100%;
    padding: 0px 4px;
    min-width: 100px;
}

a {
    display: block;
    height: 30vh;
    position: absolute;
    bottom: 18px;
    right: 18px;
    left: 18px;
    background-color: #ccc;
    border-radius: 8px;
    text-decoration: none;
    text-align: center;
    line-height: 30vh;
    color: #000;
    font-size: 200%;
}

@media only screen and (max-width: 1023px) {
    td {
        font-size: .82em;
    }

    footer {
        padding: 4px;
    }

    label {
        font-size: .6em;
    }

    input {
        font-size: .82em;
    }

    a {
        bottom: 4px;
        right: 4px;
        left: 4px;
    }
}

</style>

<main>
    <table>
        <tbody></tbody>
    </table>
</main>
<footer>
    <label for="pricePerShare">Price per share</label>
    <input id="pricePerShare" type="number" min=".01" max="9000" step="0.01" placeholder="close price" value="2.00" />

    <label for="sharesNum">Number of shares</label>
    <input id="sharesNum" type="number" min="0" max="900000" step="100" placeholder="pos. size" value="0" />

    <label for="tradeCost">Cost of trade</label>
    <input id="tradeCost" type="number" min="0" max="90000" step="100" placeholder="total cost" value="2000" />

    <a href="javascript:scrollToBottom()">⍗</a>
</footer>

<script>

const precision = {
    pricePerShareField: 2,
    // pricePerShareFieldBefore: 2,
    pricePerShareColumn: 2,
};

const priceFormatters = [
    new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0,
    }),
    undefined,
    new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
    }),
    undefined,
    new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 4,
        maximumFractionDigits: 4,
    }),
];

function range(start, end, step) {
    var a = [start];

    for (var i = 1; start < end; i++) {
        if (start < 0 && start >= -5) {
            a[i] = ++start;
        } else {
            a[i] = (start += step);
        }
    }

    return a;
}

function empty(DOMelement) {
    while (DOMelement.firstChild) DOMelement.removeChild(DOMelement.firstChild);
}

function scrollToBottom() {
    var element = DOMcurrSpread.parentNode.parentNode;
    element.scrollTop = element.scrollHeight - element.clientHeight;
}

function calculatePriceBasedOnPercentage(percentage, pricePerShareValue) {
    return percentage * pricePerShareValue / 100 + pricePerShareValue;
}

function formatGainField(percentage, pricePerShareValue) {
    var gain = (percentage * pricePerShareValue / 100 + pricePerShareValue) / pricePerShareValue;

    return isNaN(gain) ? '∞' : ('×' + gain.toFixed(2));
}

function formatEarningsField(neg, percentage, pricePerShareValue, sharesNumValue) {
    var gain = Math.abs(percentage * pricePerShareValue / 100 * sharesNumValue);

    return ((neg) ? '(' : ' ') + priceFormatters[2].format(gain) + ((neg) ? ')' : ' ');
}

function formatResultField(neg, percentage, pricePerShareValue, sharesNumValue, tradeCostValue) {
    var gain = percentage * pricePerShareValue / 100 * sharesNumValue;

    return '$' + ((gain|0) + tradeCostValue);
}

function update() {
    var pricePerShareValue = +DOMpricePerShare.value;
    var sharesNumValue = +DOMsharesNum.value;
    var tradeCostValue = +DOMtradeCost.value;

    empty(DOMcurrSpread);

    var frag = document.createDocumentFragment();

    for (var i = 0, ilen = percentages.length; i < ilen; i++) {
        var neg = percentages[i] < 0;
        var pos = percentages[i] > 0;

        var trNode  = document.createElement('tr')
          , tdNode1 = document.createElement('td')
          , tdNode2 = document.createElement('td')
          , tdNode3 = document.createElement('td')
          , tdNode4 = document.createElement('td');

        trNode.className = (neg) ? 'neg' : (pos) ? 'pos' : '';

        tdNode1.innerHTML = ((pos) ? '+' : '') + percentages[i] + '%';

        var price = priceFormatters[precision.pricePerShareColumn].format(calculatePriceBasedOnPercentage(percentages[i], pricePerShareValue));
        tdNode2.innerHTML = price;
        tdNode2.title = ((pos) ? '+' : '') + (calculatePriceBasedOnPercentage(percentages[i], pricePerShareValue) - pricePerShareValue).toFixed(precision.pricePerShareColumn);

        tdNode3.innerHTML = formatGainField(percentages[i], pricePerShareValue);

        tdNode4.innerHTML = formatEarningsField(neg, percentages[i], pricePerShareValue, sharesNumValue);
        tdNode4.title = formatResultField(neg, percentages[i], pricePerShareValue, sharesNumValue, tradeCostValue);

        trNode.appendChild(tdNode1);
        trNode.appendChild(tdNode2);
        trNode.appendChild(tdNode3);
        trNode.appendChild(tdNode4);

        frag.appendChild(trNode);
    }

    DOMcurrSpread.appendChild(frag);

    document.title =
        priceFormatters[precision.pricePerShareField].format(pricePerShareValue) +
        ' × ' + sharesNumValue +
        ' = ' + priceFormatters[2].format(tradeCostValue);
}

function updatePrecision() {
    var pricePerShareRawValue = DOMpricePerShare.value;
    var pricePerShareValue = +pricePerShareRawValue;

    if (pricePerShareValue % 1 == 0 && pricePerShareValue >= 100) {
        precision.pricePerShareField = 0;
        precision.pricePerShareColumn = 2;
    } else {
        if (pricePerShareValue < 1) {
            precision.pricePerShareField = 4;
            precision.pricePerShareColumn = 4;
        } else {
            precision.pricePerShareField = 2;
            precision.pricePerShareColumn = 2;

            if (pricePerShareValue % 1 > 0) {
                var fractionLength = pricePerShareRawValue.split('.')[1].length;

                if (fractionLength > 2) {
                    precision.pricePerShareField = 4;
                    precision.pricePerShareColumn = 4;
                }
            }
        }
    }

    DOMpricePerShare.setAttribute('step', 1 / Math.pow(10, precision.pricePerShareField));
    DOMpricePerShare.setAttribute('min', 1 / Math.pow(10, precision.pricePerShareField));
}

function newPricePerShare() {
    var pricePerShareValue = +DOMpricePerShare.value;
    var tradeCostValue = +DOMtradeCost.value;

    updatePrecision();

    // if (pricePerShareValue > 0) {
    //     DOMpricePerShare.value = pricePerShareValue.toFixed(2);
    // }

    DOMsharesNum.value = Math.floor(tradeCostValue / pricePerShareValue);
    if (DOMsharesNum.value == "") {
        DOMsharesNum.value = 0;
    }

    update();
}

function newPositionSize() {
    var pricePerShareValue = +DOMpricePerShare.value;
    var sharesNumValue = +DOMsharesNum.value;

    DOMtradeCost.value = Math.floor(pricePerShareValue * sharesNumValue);

    update();
}

function newAmountOfShares() {
    var pricePerShareValue = +DOMpricePerShare.value;
    var tradeCostValue = +DOMtradeCost.value;

    DOMsharesNum.value = Math.floor(tradeCostValue / pricePerShareValue);

    update();
}

var percentages = range(-50, 5000, 5).reverse();

var DOMpricePerShare = document.getElementById('pricePerShare');
var DOMsharesNum = document.getElementById('sharesNum');
var DOMtradeCost = document.getElementById('tradeCost');
var DOMcurrSpread = document.getElementsByTagName('tbody')[0];

DOMpricePerShare.addEventListener('input', newPricePerShare);
DOMsharesNum.addEventListener('input', newPositionSize);
DOMtradeCost.addEventListener('input', newAmountOfShares);

DOMpricePerShare.addEventListener('mouseover', function () {
    this.select();
});
DOMsharesNum.addEventListener('mouseover', function () {
    this.select();
});
DOMtradeCost.addEventListener('mouseover', function () {
    this.select();
});

// window.addEventListener('resize', scrollToBottom);

newPricePerShare();
scrollToBottom();

</script>
